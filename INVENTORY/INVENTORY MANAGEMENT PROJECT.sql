--- Creating Database

CREATE DATABASE INVENTORY

-- Entering into the data base
USE INVENTORY

---***** CREATING TABLE SUPPLIER AND APPLYING CONSTRINTS ****

CREATE TABLE SUPPLIER
(SID CHAR(5) PRIMARY KEY,
SNAME VARCHAR(20) NOT NULL,
SADDRESS VARCHAR(50) NOT NULL,
SCITY VARCHAR(20) DEFAULT 'DELHI',
SPHONE CHAR(10) UNIQUE,
EMAIL VARCHAR(50));



------------------------------------------------

---**** CREATING TABLE PRODUCT AND APPLYING CONSTRINTS ****
CREATE TABLE PRODUCT
(PID CHAR(5) PRIMARY KEY,
PDESC VARCHAR(50) NOT NULL,
PRICE INT CHECK(PRICE>0),
CATEGORY CHAR(2) CHECK (CATEGORY IN ('IT','HA','HC')),
SID CHAR(5) FOREIGN KEY REFERENCES SUPPLIER(SID));


-------------------------------------------------------

---*** CREATE TABLE STOCK & APPLYING CONSTRAINTS ***

CREATE TABLE STOCK
(PID CHAR(5) FOREIGN KEY REFERENCES PRODUCT(PID),
SQTY INT CHECK(SQTY>=0),
ROL INT CHECK(ROL>10),---Reorder level
MOQ INT CHECK (MOQ>=5))--- Minimum order quantity


--*** CREATE CUSTOMER TABLE APPLYING CONSTRAINTS ****

CREATE TABLE CUSTOMER
(CID CHAR(5) PRIMARY KEY,
CNAME VARCHAR(20) NOT NULL,
ADDRESS VARCHAR(20) NOT NULL,
CITY VARCHAR(10) NOT NULL,
PHONE CHAR(10) NOT NULL,
EMAIL VARCHAR(50) NOT NULL,
DOB DATE CHECK(DOB<'01-JAN-2000'));


---*** CREATE TABLE ORDERS AND APPLYING CONSTRAINTS ****

CREATE TABLE ORDERS
(OID CHAR(5) PRIMARY KEY,
ODATE DATE,
PID CHAR(5) FOREIGN KEY REFERENCES PRODUCT(PID),
CID CHAR(5) FOREIGN KEY REFERENCES CUSTOMER(CID));

ALTER TABLE ORDERS
ADD OQTY INT

----**** INSERTING DATA INTO SUPPLIER TABLE *******

INSERT INTO SUPPLIER
VALUES('S0001','ABILASH','2-90 SRINAGAR','DELHI','9023092332','abilash22@gmail.com'),
('S0002','SRIRAM','3-2 CHANDNAGAR','DELHI','9000092332','sriram@gmail.com');

INSERT INTO SUPPLIER
VALUES('S0003','ANIL KUMAR','1-98 CITYROAD','DELHI','9023123332','anil56@gmail.com'),
('S0004','POORNA','3-2 AGRA','DELHI','9236092332','poorna@gmail.com'),
('S0005','SANTHOSH KUMAR','23-5 UTTHAMNAGAR','DELHI','9016235698','santhosh@gmail.com'),
('S0006','ANJALI','2-98 UTTHAMNAGAR','DELHI','9018963256','anjali@gmail.com'),
('S0007','DHANUSH CHANDHRA','23-5 MAIN ROAD','DELHI','9856235698','dhanush@gmail.com'),
('S0008','SARALA','2-01 M ROAD','DELHI','9016238998','sarala@gmail.com'),
('S0009','KIRAN KUMAR','1-11 METRO NAGAR','DELHI','9015687698','kiran99@gmail.com'),
('S0010','UPENDHAR','89-66 SMART BAZAR','DELHI','9016235620','upendhar@gmail.com');


---- FETCHING DATA FROM SUPPLIER TABLE

SELECT * FROM SUPPLIER

----*** INSERTING DATA INTO PRODUCT TABLE *****



INSERT INTO PRODUCT
VALUES('P0001' ,'Mouse Intel pro','1500','IT','S0001'),
('P0002',' Laptop Inter celeron 3205U','50000','IT','S0001'),
('P0003',' keyboard Intel Pro 99','1000','IT','S0001'),
('P0004','printer intel','15000','IT','S0001'),
('P0005','Scanner intel pro','10000','IT','S0001'),
('P0006','Sanitizer','1000','HC','S0002'),
('P0007','Mask','1200','HC','S0002'),
('P0008','Syringes','1450','HC','S0003'),
('P0009','Needles','2000','HC','S0004'),
('P0010','Microwave philiphs','20000','HA','S0003'),
('P0011','Kettle','3000','HA','S0004'),
('P0012','Wahing Machine Panasonic','20000','HA','S0005'),
('P0013','Grinder','6000','HA','S0006'),
('P0014','Television','21000','HA','S0010'),
('P0015','Rice Cooker','6000','HA','S0009');

---FETCHING DATA FROM PRODUCT TABLE

SELECT * FROM PRODUCT


---*** INSERTING DATA INTO STOCK TABLE ****

INSERT INTO STOCK
VALUES('P0001','20','11','10')

INSERT INTO STOCK
VALUES('P0002','30','11','10'),
('P0003','15','12','10'),
('P0004','12','15','10'),
('P0005','100','12','10'),
('P0006','50','11','5'),
('P0006','20','11','5'),
('P0007','25','11','5'),
('P0008','25','11','5'),
('P0009','23','11','5'),
('P0010','25','11','5');

--- FETCH DATA FROM STOCK TABLE

SELECT * FROM STOCK

----INSERTING DATA INTO CUSTOMER TABLE
INSERT INTO CUSTOMER
VALUES('C0001','SARATH KUMAR','AMEERPET','HYD','9236987545','sarath@gmail.com','01-JUL-1989'),
('C0002','RAMESH','HITECH CITY','HYD','9237887545','ramesh@gmail.com','11-AUG-1989'),
('C0003','ANITHA','X ROAD','CHENNAI','9236987578','anitha@gmail.com','21-JUN-1999'),
('C0004','SARATH','AMEERPET','HYD','9236987545','sarath@gmail.com','01-SEP-1986'),
('C0005','SRAVAN KUMAR','RG ROAD','BENGOLORE','8936987545','sravan@gmail.com','21-APR-1989'),
('C0006','RAMYA','SH ROAD','CHENNAI','8975987545','ramya@gmail.com','23-JUL-1985'),
('C0007','SAARA','KPHB','HYD','9236987545','saara@gmail.com','01-JUN-1987'),
('C0008','ANAND','JNTU','HYD','9236987540','anand@gmail.com','01-JUN-1989'),
('C0009','MAHESH','SR NAGAR','HYD','9236087545','maheh@gmail.com','01-OCT-1987'),
('C0010','GURUNATH','NEAR METRO STATION','HYD','9230987545','gurunath@gmail.com','01-FEB-1999'),
('C0011','SOWMYA','CROSS ROAD','HYD','9206987545','sowmya@gmail.com','11-JUL-1984');

---*** FETCHING DATA FROM CUSTOMER TABLE***
SELECT * FROM CUSTOMER


---- INSERTING DATA INTO ORDERS TABLE

INSERT INTO ORDERS
VALUES('O0001','12-JAN-2023','P0001','C0001','1'),
('O0002','02-JUL-2023','P0002','C0002','1'),
('O0003','12-MAY-2023','P0003','C0003','1'),
('O0004','12-OCT-2023','P0004','C0004','1'),
('O0005','22-DEC-2023','P0005','C0005','50'),
('O0006','25-FEB-2023','P0006','C0006','10'),
('O0007','12-JUL-2023','P0005','C0007','10');

---- FETCHING DATA FROM ORDERS TABLE

SELECT * FROM ORDERS



--- CREATING VIEW

CREATE VIEW BILL
AS
SELECT O.OID,O.ODATE,O.OQTY ,C.CNAME,C.ADDRESS,C.PHONE,P.PDESC,P.PRICE, O.OQTY * P.PRICE AS AMOUNT
FROM CUSTOMER C
JOIN
ORDERS O
ON C.CID = O.CID
JOIN
PRODUCT P
ON O.PID = P.PID 


SELECT * FROM BILL

/* create procedure - name given to a pre wriiten code,stored procedure is prepared sql code that we save so we can re use
over and over again instead of writing query each time*/

--By using procedure inserting data into tables

SELECT * FROM SUPPLIER


CREATE PROCEDURE ADDSUPPLIER 
@SID as CHAR(5),@SNAME as VARCHAR(20),@SADDRESS as VARCHAR(50),@SCITY as VARCHAR(20),@SPHONE CHAR(10),@EMAIL VARCHAR(50)
AS 
BEGIN
SET NOCOUNT ON
INSERT INTO SUPPLIER
VALUES(@SID,@SNAME,@SADDRESS,@SCITY,@SPHONE,@EMAIL)
END;

ADDSUPPLIER'S0011','VIKRANTH REDDY','X-ROAD','MUMBAI','9875463698','vikranth@gmail.com'

ADDSUPPLIER'S0012','RAAJEEV','MSR-ROAD','KOLKATHA','8975463698','raajeev@gmail.com'

SELECT * FROM SUPPLIER

------------------------------------------------------------------------------
SELECT * FROM PRODUCT

CREATE PROCEDURE ADDPRO
@PID as CHAR(5),@PDSC as VARCHAR(50),@PRICE as INT,@CATEGORY as CHAR(2),@SID AS CHAR(5)
AS 
BEGIN
SET NOCOUNT ON
INSERT INTO PRODUCT
VALUES(@PID,@PDSC,@PRICE,@CATEGORY,@SID)
END;

ADDPRO'P0016','JUICER',1000,'HA','S0009'
ADDPRO'P0017','BLENDER',800,'HA','S0009'
ADDPRO'P0018','MEDICINE',8000,'HC','S0001'
ADDPRO'P0019','MOBILE',1000,'IT','S0007'
ADDPRO'P0020','FAN',1000,'HA','S0010'

---------------------------------------------------
SELECT * FROM CUSTOMER

CREATE PROCEDURE ADDCUST 
@CID as CHAR(5),@CNAME as VARCHAR(20),@ADDRESS as VARCHAR(20),@CITY as VARCHAR(10),@PHONE as CHAR(10),@EMAIL VARCHAR(50),@DOB as DATE
AS 
BEGIN
SET NOCOUNT ON
INSERT INTO CUSTOMER
VALUES(@CID,@CNAME,@ADDRESS,@CITY,@PHONE,@EMAIL,@DOB)
END;

ADDCUST'C0012','VIKRANTH REDDY','HITECH CITY','MUMBAI','7575463698','vikranth@gmail.com','12-jan-1998';
ADDCUST'C0013','SARANYA','BANZARA HILLS','HYD','9075463698','saranya@gmail.com','15-mar-1987';
ADDCUST'C0014','RAGHU RAM','HITECH CITY','MUMBAI','7570063698','raghu@gmail.com','12-oct-1998';
ADDCUST'C0015','SUNEETHA RANI','BANZARA HILLS','HYDERBAD','9075463692','suneetha@gmail.com','12-mar-1984';


---------------------------------------------------------------------------------------------
SELECT * FROM ORDERS

CREATE PROCEDURE ADDORDER
@OID as CHAR(5),@ODATE as DATE,@PID as CHAR(5),@CID as CHAR(5),@OQTY AS INT
AS 
BEGIN
SET NOCOUNT ON
INSERT INTO ORDERS(OID,ODATE,PID,CID,OQTY)
VALUES(@OID,GETDATE(),@PID,@CID,@OQTY)
END;

---DROP PROCEDURE ADDORDER
/*INSERTING DATA BY USING PROCEDURE*/
ADDORDER'O0008','','P0001','C0002','5'
ADDORDER'O0009','','P0002','C0003','15'

/* DROPPING PROCEDURES*/

DROP PROCEDURE ADDSUPPLIER
DROP PROCEDURE ADDPRO
DROP PROCEDURE ADDCUST
DROP PROCEDURE ADDORDER





--USING FUNCTIONS AND PROCEDURES FOR INSERTING DATA INTO TABLES---
----------------------------------------------------------------------
/* function for creating SID*/

CREATE FUNCTION GenerateSID()
RETURNS CHAR(5)
AS
BEGIN
    DECLARE @NewID CHAR(5);

    -- Generate new SID
    SELECT @NewID = RIGHT('S' + RIGHT('0000' + CAST(ISNULL(MAX(CAST(SUBSTRING(SID, 2, 5) AS INT)), 0) + 1 AS VARCHAR(5)), 4), 5)
    FROM SUPPLIER;

    RETURN @NewID;
END;

/* function for creating PID*/
DROP FUNCTION GeneratePID
CREATE FUNCTION GeneratePID()
RETURNS CHAR(5)
AS
BEGIN
    DECLARE @NewID CHAR(5);

    -- Generate new PID
    SELECT @NewID = RIGHT('P' + RIGHT('0000' + CAST(ISNULL(MAX(CAST(SUBSTRING(PID, 2, 5) AS INT)), 0) + 1 AS VARCHAR(5)), 4), 5)
    FROM PRODUCT;

    RETURN @NewID;
END;

/* function for creating CID*/

CREATE FUNCTION GenerateCID()
RETURNS CHAR(5)
AS
BEGIN
    DECLARE @NewID CHAR(5);

    -- Generate new CID
    SELECT @NewID = RIGHT('C' + RIGHT('0000' + CAST(ISNULL(MAX(CAST(SUBSTRING(CID, 2, 5) AS INT)), 0) + 1 AS VARCHAR(5)), 4), 5)
    FROM CUSTOMER;

    RETURN @NewID;
END;

/* function for creating OID*/

CREATE FUNCTION GenerateOID()
RETURNS CHAR(5)
AS
BEGIN
    DECLARE @NewID CHAR(5);

    -- Generate new OID
    SELECT @NewID = RIGHT('O' + RIGHT('0000' + CAST(ISNULL(MAX(CAST(SUBSTRING(OID, 2, 5) AS INT)), 0) + 1 AS VARCHAR(5)), 4), 5)
    FROM ORDERS;

    RETURN @NewID;
END;
-------------------------------------------------------------------------
DROP PROCEDURE ADDSUPPLIER

CREATE PROCEDURE ADDSUPPLIER 
    @SNAME VARCHAR(20), 
    @SADDRESS VARCHAR(50), 
    @SCITY VARCHAR(20) = 'DELHI', 
    @SPHONE CHAR(10), 
    @EMAIL VARCHAR(50)
AS 
BEGIN
    SET NOCOUNT ON;
    DECLARE @SID CHAR(5) = dbo.GenerateSID();
    
    INSERT INTO SUPPLIER (SID, SNAME, SADDRESS, SCITY, SPHONE, EMAIL)
    VALUES (@SID, @SNAME, @SADDRESS, @SCITY, @SPHONE, @EMAIL);
END;

-- Usage
EXEC ADDSUPPLIER 'VIKAS REDDY', 'M-ROAD', 'PUNE', '9700044698', 'vikas@gmail.com';

EXEC ADDSUPPLIER 'SRIDHAR REDDY', 'MHS-CROSS ROAD', 'DELHI', '9701163698', 'sridhar@gmail.com';

-------------------------------------------------------------------------------------------------------


CREATE PROCEDURE ADDPRO
    @PDSC VARCHAR(50), 
    @PRICE INT, 
    @CATEGORY CHAR(2), 
    @SID CHAR(5)
AS 
BEGIN
    SET NOCOUNT ON;
    DECLARE @PID CHAR(5) = dbo.GeneratePID();
    
    INSERT INTO PRODUCT (PID, PDESC, PRICE, CATEGORY, SID)
    VALUES (@PID, @PDSC, @PRICE, @CATEGORY, @SID);
END;

-- Usage
EXEC ADDPRO 'COOKER', 1000, 'HA', 'S0009';
--------------------------------------------------------------------
CREATE PROCEDURE ADDCUST 
    @CNAME VARCHAR(20), 
    @ADDRESS VARCHAR(20), 
    @CITY VARCHAR(10), 
    @PHONE CHAR(10), 
    @EMAIL VARCHAR(50), 
    @DOB DATE
AS 
BEGIN
    SET NOCOUNT ON;
    
    DECLARE @NewCID CHAR(5) = dbo.GenerateCID();
    
    INSERT INTO CUSTOMER (CID, CNAME, ADDRESS, CITY, PHONE, EMAIL, DOB)
    VALUES (@NewCID, @CNAME, @ADDRESS, @CITY, @PHONE, @EMAIL, @DOB);
END;

-- Usage example:
EXEC ADDCUST 'VIMALA', 'GMS CITY', 'MUMBAI', '7575463690', 'vimala@gmail.com', '1997-01-12';

-------------------------------------------------------------------
CREATE PROCEDURE ADDORDER
    @CID CHAR(5), 
    @PID CHAR(5), 
    @OQTY INT
AS 
BEGIN
    SET NOCOUNT ON;
    DECLARE @OID CHAR(5) = dbo.GenerateOID();
    
    INSERT INTO ORDERS (OID, ODATE, PID, CID, OQTY)
    VALUES (@OID, GETDATE(), @PID, @CID, @OQTY);
END;

-- Usage
EXEC ADDORDER 'C0002', 'P0001', 5;
EXEC ADDORDER 'C0002', 'P0001', 10;



SELECT * FROM SUPPLIER
SELECT * FROM PRODUCT
SELECT * FROM CUSTOMER
SELECT * FROM ORDERS
SELECT * FROM STOCK

----- TRIGGER

CREATE TRIGGER trg_UpdateStock
ON ORDERS
AFTER INSERT
AS 
BEGIN
    SET NOCOUNT ON;
    UPDATE STOCK
    SET SQTY = SQTY - i.OQTY
    FROM STOCK s
    INNER JOIN inserted i ON s.PID = i.PID
    WHERE s.PID = i.PID;
END;
